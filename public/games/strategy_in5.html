<!DOCTYPE html>
<html lang="en-GB">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Platform Jumping Adventure | UK's Favorite Retro Gaming Experience</title>
    <meta name="description" content="Play our retro-inspired platform jumping game designed for UK gamers. Challenge yourself with British-themed levels, collect coins and compete for the highest score!">
    <meta name="keywords" content="platform jumping game UK, British adventure platformer, retro gaming UK, online platform game, UK game site">
    <meta name="author" content="Platform Adventure Team">
    <meta name="geo.region" content="GB">
    <meta name="geo.placename" content="London">
    <meta name="geo.position" content="51.5074;-0.1278">
    <meta name="ICBM" content="51.5074, -0.1278">
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://cdn.jsdelivr.net/npm/font-awesome@4.7.0/css/font-awesome.min.css" rel="stylesheet">
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700&display=swap" rel="stylesheet">
    <script>
        tailwind.config = {
            theme: {
                extend: {
                    colors: {
                        primary: '#005EA5', // UK Government Digital Service blue
                        secondary: '#00823B', // UK Government Digital Service green
                        danger: '#D4351C', // UK Government Digital Service red
                        dark: '#1E293B',
                        light: '#F8FAFC',
                        accent: '#FFDD00' // UK yellow warning color
                    },
                    fontFamily: {
                        sans: ['Inter', 'system-ui', 'sans-serif'],
                    },
                }
            }
        }
    </script>
    <style type="text/tailwindcss">
        @layer utilities {
            .content-auto {
                content-visibility: auto;
            }
            .game-shadow {
                box-shadow: 0 0 25px rgba(0, 0, 0, 0.2);
            }
            .btn-hover {
                @apply transition-all duration-300 hover:scale-105 active:scale-95;
            }
            .uk-flag-gradient {
                background: linear-gradient(135deg, #00247D 25%, transparent 25%),
                            linear-gradient(225deg, #00247D 25%, transparent 25%),
                            linear-gradient(315deg, #00247D 25%, transparent 25%),
                            linear-gradient(45deg, #00247D 25%, transparent 25%),
                            linear-gradient(90deg, transparent 45%, #D80027 45%, #D80027 55%, transparent 55%),
                            linear-gradient(0deg, transparent 45%, #D80027 45%, #D80027 55%, transparent 55%);
                background-size: 50px 50px;
                background-color: #FFFFFF;
            }
            .particle {
                position: absolute;
                pointer-events: none;
                border-radius: 50%;
                opacity: 0.8;
            }
        }
    </style>
</head>
<body class="bg-gradient-to-br from-slate-900 to-slate-800 min-h-screen flex items-center justify-center p-4 font-sans text-light">
    <div class="relative game-container max-w-4xl w-full mx-auto">
        <!-- 游戏标题 -->
        <h1 class="text-[clamp(2rem,5vw,3.5rem)] font-bold text-center mb-4 text-primary">
            <i class="fa fa-gamepad mr-2"></i>Platform Jumping Adventure
        </h1>
        
        <!-- 英国本地化标志 -->
        <div class="absolute top-4 right-4 flex items-center gap-2">
            <div class="w-8 h-8 rounded-full overflow-hidden uk-flag-gradient"></div>
            <span class="text-sm text-slate-300">UK Edition</span>
        </div>
        
        <!-- 游戏数据显示 -->
        <div class="flex justify-between items-center mb-4 px-4 py-2 bg-slate-800/50 rounded-lg game-shadow">
            <div class="flex items-center space-x-4">
                <div class="flex items-center">
                    <i class="fa fa-star text-yellow-400 mr-2"></i>
                    <span id="currentScore" class="text-xl font-bold">0</span>
                </div>
                <div class="flex items-center">
                    <i class="fa fa-heart text-danger mr-2"></i>
                    <span id="lives" class="text-xl font-bold">3</span>
                </div>
                <div class="flex items-center">
                    <i class="fa fa-signal text-secondary mr-2"></i>
                    <span id="level" class="text-xl font-bold">1</span>
                </div>
                <div class="flex items-center">
                    <i class="fa fa-coins text-accent mr-2"></i>
                    <span id="coins" class="text-xl font-bold">0</span>
                </div>
            </div>
            <div class="flex items-center">
                <div class="flex items-center">
                    <i class="fa fa-trophy text-amber-500 mr-2"></i>
                    <span id="displayHighScore" class="text-xl font-bold">0</span>
                </div>
                <button id="desktopPauseBtn" class="ml-4 px-3 py-1.5 bg-primary/80 hover:bg-primary rounded-md transition-all">
                    <i class="fa fa-pause"></i>
                </button>
            </div>
        </div>
        
        <!-- 游戏Canvas -->
        <canvas id="gameCanvas" class="w-full h-auto rounded-lg bg-slate-900 game-shadow"></canvas>
        
        <!-- 粒子效果容器 -->
        <div id="particlesContainer" class="absolute top-0 left-0 w-full h-full pointer-events-none z-10"></div>
        
        <!-- 移动设备控制按钮 -->
        <div class="mt-4 flex justify-center space-x-4 md:hidden">
            <button id="mobileLeftBtn" class="w-16 h-16 bg-primary/80 rounded-full flex items-center justify-center text-2xl btn-hover">
                <i class="fa fa-arrow-left"></i>
            </button>
            <button id="mobileJumpBtn" class="w-20 h-20 bg-secondary/80 rounded-full flex items-center justify-center text-2xl btn-hover">
                <i class="fa fa-arrow-up"></i>
            </button>
            <button id="mobileRightBtn" class="w-16 h-16 bg-primary/80 rounded-full flex items-center justify-center text-2xl btn-hover">
                <i class="fa fa-arrow-right"></i>
            </button>
        </div>
        
        <!-- 游戏开始界面 -->
        <div id="gameStartScreen" class="absolute inset-0 bg-slate-900/80 rounded-lg flex flex-col items-center justify-center z-10">
            <h2 class="text-[clamp(1.5rem,3vw,2.5rem)] font-bold text-center mb-6 text-primary">
                Ready for Adventure!
            </h2>
            <p class="text-lg mb-8 max-w-md text-center px-4">
                Use arrow keys or WASD to move and jump. Avoid obstacles, collect coins, and see how high you can score!
            </p>
            <div class="flex flex-col sm:flex-row gap-4">
                <button id="startGameBtn" class="px-8 py-3 bg-primary rounded-lg text-lg font-bold shadow-lg btn-hover active:scale-95 transition-all">
                    <i class="fa fa-play mr-2"></i>Start Game
                </button>
                <button id="howToPlayBtn" class="px-8 py-3 bg-slate-700/80 rounded-lg text-lg font-bold shadow-lg btn-hover">
                    <i class="fa fa-info-circle mr-2"></i>How to Play
                </button>
            </div>
            <div class="mt-8 text-center">
                <p class="text-slate-400">High Score: <span id="highScore" class="font-bold text-primary">0</span></p>
            </div>
        </div>
        
        <!-- 游戏暂停界面 -->
        <div id="gamePauseScreen" class="absolute inset-0 bg-slate-900/80 rounded-lg flex flex-col items-center justify-center z-10 hidden">
            <h2 class="text-[clamp(1.5rem,3vw,2.5rem)] font-bold text-center mb-8 text-primary">
                Game Paused
            </h2>
            <div class="flex flex-col sm:flex-row gap-4">
                <button id="resumeGameBtn" class="px-8 py-3 bg-primary rounded-lg text-lg font-bold shadow-lg btn-hover">
                    <i class="fa fa-play mr-2"></i>Resume Game
                </button>
                <button id="restartGameBtn" class="px-8 py-3 bg-slate-700/80 rounded-lg text-lg font-bold shadow-lg btn-hover">
                    <i class="fa fa-refresh mr-2"></i>Restart Game
                </button>
            </div>
        </div>
        
        <!-- 游戏结束界面 -->
        <div id="gameOverScreen" class="absolute inset-0 bg-slate-900/80 rounded-lg flex flex-col items-center justify-center z-10 hidden">
            <h2 class="text-[clamp(1.5rem,3vw,2.5rem)] font-bold text-center mb-4 text-danger">
                Game Over
            </h2>
            <p class="text-xl mb-2">Your Score: <span id="finalScore" class="font-bold text-primary">0</span></p>
            <p class="text-lg mb-2">Coins Collected: <span id="finalCoins" class="font-bold text-accent">0</span></p>
            <p class="text-lg mb-8">High Score: <span id="finalHighScore" class="font-bold text-primary">0</span></p>
            <button id="playAgainBtn" class="px-8 py-3 bg-primary rounded-lg text-lg font-bold shadow-lg btn-hover">
                <i class="fa fa-refresh mr-2"></i>Play Again
            </button>
        </div>
        
        <!-- 关卡升级提示 -->
        <div id="levelUpScreen" class="absolute inset-0 bg-slate-900/60 rounded-lg flex items-center justify-center z-10 hidden">
            <div class="bg-primary/90 p-6 rounded-lg text-center shadow-2xl transform transition-all scale-100">
                <h3 class="text-2xl font-bold mb-2">Level Up!</h3>
                <p class="text-xl mb-4">You've reached Level <span id="newLevel" class="font-bold">2</span>!</p>
                <button id="continueBtn" class="px-6 py-2 bg-white text-primary font-bold rounded-md hover:bg-slate-200 transition-all">
                    Continue
                </button>
            </div>
        </div>
        
        <!-- 角色选择界面 -->
        <div id="characterSelectScreen" class="absolute inset-0 bg-slate-900/80 rounded-lg flex flex-col items-center justify-center z-10 hidden">
            <h2 class="text-[clamp(1.5rem,3vw,2.5rem)] font-bold text-center mb-6 text-primary">
                Select Your Character
            </h2>
            <div class="grid grid-cols-2 sm:grid-cols-4 gap-4 mb-8">
                <div class="character-option bg-slate-800 p-4 rounded-lg cursor-pointer hover:bg-slate-700 transition-all border-2 border-transparent" data-character="default">
                    <div class="w-20 h-20 bg-blue-500 mx-auto mb-2"></div>
                    <p class="text-center">Default</p>
                </div>
                <div class="character-option bg-slate-800 p-4 rounded-lg cursor-pointer hover:bg-slate-700 transition-all border-2 border-transparent" data-character="london">
                    <div class="w-20 h-20 bg-primary mx-auto mb-2"></div>
                    <p class="text-center">London</p>
                </div>
                <div class="character-option bg-slate-800 p-4 rounded-lg cursor-pointer hover:bg-slate-700 transition-all border-2 border-transparent" data-character="scotland">
                    <div class="w-20 h-20 bg-secondary mx-auto mb-2"></div>
                    <p class="text-center">Scotland</p>
                </div>
                <div class="character-option bg-slate-800 p-4 rounded-lg cursor-pointer hover:bg-slate-700 transition-all border-2 border-transparent" data-character="wales">
                    <div class="w-20 h-20 bg-danger mx-auto mb-2"></div>
                    <p class="text-center">Wales</p>
                </div>
            </div>
            <button id="confirmCharacterBtn" class="px-8 py-3 bg-primary rounded-lg text-lg font-bold shadow-lg btn-hover">
                Confirm Selection
            </button>
        </div>
        
        <!-- 游戏说明模态框 -->
        <div id="howToPlayModal" class="fixed inset-0 bg-black/70 flex items-center justify-center z-20 hidden">
            <div class="bg-slate-800 rounded-lg p-6 max-w-md w-full mx-4 shadow-2xl">
                <div class="flex justify-between items-center mb-4">
                    <h3 class="text-xl font-bold text-primary">How to Play</h3>
                    <button id="closeModalBtn" class="text-slate-400 hover:text-white">
                        <i class="fa fa-times"></i>
                    </button>
                </div>
                <div class="mb-6">
                    <p class="mb-4">Control your character to jump on platforms and avoid red obstacles.</p>
                    <div class="space-y-2">
                        <p><i class="fa fa-arrow-right text-primary mr-2"></i> Arrow Left/Right or A/D - Move Left/Right</p>
                        <p><i class="fa fa-arrow-up text-primary mr-2"></i> Arrow Up or W/Space - Jump</p>
                        <p><i class="fa fa-pause text-primary mr-2"></i> P Key - Pause/Resume Game</p>
                        <p><i class="fa fa-random text-primary mr-2"></i> C Key - Change Character</p>
                    </div>
                    <div class="mt-4 p-3 bg-slate-700/50 rounded-lg">
                        <h4 class="font-bold mb-2 text-accent">British Gaming Tips:</h4>
                        <ul class="list-disc pl-5 space-y-1 text-sm">
                            <li>Levels are designed with British landmarks in mind!</li>
                            <li>Collect coins to unlock special UK-themed characters!</li>
                            <li>Double-tap jump for a higher leap (perfect for tricky platforms!)</li>
                            <li>Reach level 10 to unlock a special bonus stage!</li>
                        </ul>
                    </div>
                </div>
                <button id="closeHowToPlayBtn" class="w-full py-2 bg-primary rounded-md hover:bg-primary/90 transition-all">
                    Got it!
                </button>
            </div>
        </div>
        
        <!-- 英国本地化信息 -->
        <div class="mt-4 text-center text-xs text-slate-500">
            <p>Designed for UK Players | © 2025 Platform Adventure Team | Last updated: 02/07/2025</p>
        </div>
    </div>

    <script>
        // 等待DOM加载完成后执行游戏初始化
        document.addEventListener('DOMContentLoaded', function() {
            // 游戏变量
            let canvas, ctx;
            let gameStarted = false;
            let gamePaused = false;
            let gameOver = false;
            let score = 0;
            let highScore = localStorage.getItem('highScore') || 0;
            let lives = 3;
            let level = 1;
            let coins = 0;
            let selectedCharacter = 'default';
            let characterUnlocks = {
                london: true,
                scotland: false,
                wales: false
            };
            
            // 游戏配置
            const GAME_CONFIG = {
                platformMinWidth: 80,
                platformMaxWidth: 150,
                platformMinGap: 60,  // 最小间距 - 调整为可跳跃范围
                platformMaxGap: 120, // 最大间距 - 根据玩家跳跃能力调整
                platformMinY: 100,   // 平台最小Y坐标
                platformMaxY: 400,   // 平台最大Y坐标
                playerJumpStrength: -15, // 跳跃力度
                playerDoubleJumpStrength: -12, // 二段跳力度
                gravity: 0.7, // 重力
                levelScoreThreshold: 1500, // 升级所需分数
                obstacleSpawnRate: 0.5, // 障碍物生成概率
                movingPlatformRate: 0.3, // 移动平台出现概率
                springPlatformRate: 0.2, // 弹簧平台出现概率
            };
            
            // 角色属性
            let player = {
                x: 50,
                y: 0,
                width: 30,
                height: 40,
                velocityY: 0,
                velocityX: 0,
                jumping: false,
                onGround: false,
                doubleJumpAvailable: true,
                color: '#3B82F6'
            };
            
            // 平台属性 - 增加英国地标主题平台和特殊平台
            let platforms = [
                { x: 0, y: 500, width: 800, height: 20, type: 'base' },
                { x: 200, y: 400, width: 150, height: 20, type: 'london' },
                { x: 400, y: 300, width: 150, height: 20, type: 'scotland' },
                { x: 600, y: 200, width: 150, height: 20, type: 'wales' }
            ];
            
            // 障碍物属性
            let obstacles = [
                { x: 250, y: 380, width: 50, height: 20 },
                { x: 450, y: 280, width: 50, height: 20 },
                { x: 650, y: 180, width: 50, height: 20 }
            ];
            
            // 金币属性
            let coinsList = [
                { x: 225, y: 370, width: 10, height: 10, collected: false },
                { x: 425, y: 270, width: 10, height: 10, collected: false },
                { x: 625, y: 170, width: 10, height: 10, collected: false }
            ];
            
            // 粒子效果数组
            let particles = [];
            
            // 游戏初始化
            function initGame() {
                console.log('初始化游戏...');
                
                // 获取Canvas元素和上下文
                canvas = document.getElementById('gameCanvas');
                ctx = canvas.getContext('2d');
                
                // 设置Canvas尺寸
                canvas.width = 800;
                canvas.height = 600;
                
                // 更新高分显示
                document.getElementById('displayHighScore').textContent = highScore;
                document.getElementById('highScore').textContent = highScore;
                document.getElementById('finalHighScore').textContent = highScore;
                
                // 确保Canvas可见性
                document.getElementById('gameCanvas').style.display = 'block';
                
                // 绑定游戏控制按钮事件
                bindEventListeners();
                
                // 开始游戏循环
                requestAnimationFrame(gameLoop);
                
                console.log('游戏初始化完成');
            }
            
            // 绑定事件监听器
            function bindEventListeners() {
                console.log('绑定事件监听器...');
                
                // 开始游戏按钮
                const startGameBtn = document.getElementById('startGameBtn');
                startGameBtn.addEventListener('click', function() {
                    console.log('开始游戏按钮被点击');
                    showCharacterSelect();
                });
                
                // 角色选择确认按钮
                const confirmCharacterBtn = document.getElementById('confirmCharacterBtn');
                confirmCharacterBtn.addEventListener('click', function() {
                    console.log('确认角色按钮被点击');
                    startGame();
                });
                
                // 暂停/恢复按钮
                document.getElementById('desktopPauseBtn').addEventListener('click', togglePause);
                document.getElementById('resumeGameBtn').addEventListener('click', resumeGame);
                
                // 重新开始按钮
                document.getElementById('restartGameBtn').addEventListener('click', restartGame);
                document.getElementById('playAgainBtn').addEventListener('click', restartGame);
                
                // 关卡升级继续按钮
                document.getElementById('continueBtn').addEventListener('click', () => {
                    document.getElementById('levelUpScreen').style.display = 'none';
                    gamePaused = false;
                });
                
                // 角色选择
                document.querySelectorAll('.character-option').forEach(option => {
                    option.addEventListener('click', () => {
                        document.querySelectorAll('.character-option').forEach(opt => {
                            opt.classList.remove('border-accent');
                        });
                        option.classList.add('border-accent');
                        selectedCharacter = option.dataset.character;
                        updatePlayerColor();
                    });
                });
                
                // 移动设备控制按钮
                document.getElementById('mobileLeftBtn').addEventListener('touchstart', () => { 
                    player.velocityX = -5;
                });
                document.getElementById('mobileLeftBtn').addEventListener('touchend', () => { 
                    player.velocityX = 0;
                });
                document.getElementById('mobileRightBtn').addEventListener('touchstart', () => { 
                    player.velocityX = 5;
                });
                document.getElementById('mobileRightBtn').addEventListener('touchend', () => { 
                    player.velocityX = 0;
                });
                document.getElementById('mobileJumpBtn').addEventListener('touchstart', jump);
                
                // 键盘控制
                window.addEventListener('keydown', handleKeyDown);
                window.addEventListener('keyup', handleKeyUp);
                
                // 游戏说明模态框
                document.getElementById('howToPlayBtn').addEventListener('click', () => {
                    document.getElementById('howToPlayModal').style.display = 'flex';
                });
                
                document.getElementById('closeModalBtn').addEventListener('click', () => {
                    document.getElementById('howToPlayModal').style.display = 'none';
                });
                
                document.getElementById('closeHowToPlayBtn').addEventListener('click', () => {
                    document.getElementById('howToPlayModal').style.display = 'none';
                });
                
                console.log('事件监听器绑定完成');
            }
            
            // 更新玩家颜色
            function updatePlayerColor() {
                switch(selectedCharacter) {
                    case 'london':
                        player.color = '#005EA5';
                        break;
                    case 'scotland':
                        player.color = '#00823B';
                        break;
                    case 'wales':
                        player.color = '#D4351C';
                        break;
                    default:
                        player.color = '#3B82F6';
                }
            }
            
            // 显示角色选择
            function showCharacterSelect() {
                console.log('显示角色选择界面');
                document.getElementById('gameStartScreen').style.display = 'none';
                document.getElementById('characterSelectScreen').style.display = 'flex';
                
                // 检查解锁的角色
                document.querySelectorAll('.character-option').forEach(option => {
                    const character = option.dataset.character;
                    if (!characterUnlocks[character]) {
                        option.classList.add('opacity-50', 'cursor-not-allowed');
                        option.removeEventListener('click', null);
                    } else {
                        option.classList.remove('opacity-50', 'cursor-not-allowed');
                        option.addEventListener('click', () => {
                            document.querySelectorAll('.character-option').forEach(opt => {
                                opt.classList.remove('border-accent');
                            });
                            option.classList.add('border-accent');
                            selectedCharacter = character;
                            updatePlayerColor();
                        });
                    }
                });
            }
            
            // 开始游戏
            function startGame() {
                console.log('开始游戏');
                
                // 检查并解锁角色
                if (coins >= 100 && !characterUnlocks.scotland) {
                    characterUnlocks.scotland = true;
                    showToast('Scotland character unlocked!');
                }
                
                if (coins >= 200 && !characterUnlocks.wales) {
                    characterUnlocks.wales = true;
                    showToast('Wales character unlocked!');
                }
                
                // 重置游戏状态
                gameStarted = true;
                gamePaused = false;
                gameOver = false;
                score = 0;
                lives = 3;
                level = 1;
                
                // 重置玩家位置和状态
                player.x = 50;
                player.y = 0;
                player.velocityY = 0;
                player.velocityX = 0;
                player.doubleJumpAvailable = true;
                updatePlayerColor();
                
                // 重置平台、障碍物和金币
                platforms = [
                    { x: 0, y: 500, width: 800, height: 20, type: 'base' },
                    { x: 200, y: 400, width: 150, height: 20, type: 'london' },
                    { x: 400, y: 300, width: 150, height: 20, type: 'scotland' },
                    { x: 600, y: 200, width: 150, height: 20, type: 'wales' }
                ];
                
                obstacles = [
                    { x: 250, y: 380, width: 50, height: 20 },
                    { x: 450, y: 280, width: 50, height: 20 },
                    { x: 650, y: 180, width: 50, height: 20 }
                ];
                
                coinsList = [
                    { x: 225, y: 370, width: 10, height: 10, collected: false },
                    { x: 425, y: 270, width: 10, height: 10, collected: false },
                    { x: 625, y: 170, width: 10, height: 10, collected: false }
                ];
                
                // 隐藏所有游戏界面
                document.getElementById('characterSelectScreen').style.display = 'none';
                document.getElementById('gamePauseScreen').style.display = 'none';
                document.getElementById('gameOverScreen').style.display = 'none';
                
                // 更新游戏数据显示
                updateGameStats();
                
                console.log('游戏已开始');
            }
            
            // 暂停/恢复游戏
            function togglePause() {
                console.log('切换游戏暂停状态');
                gamePaused = !gamePaused;
                
                if (gamePaused) {
                    document.getElementById('gamePauseScreen').style.display = 'flex';
                    console.log('游戏已暂停');
                } else {
                    document.getElementById('gamePauseScreen').style.display = 'none';
                    console.log('游戏已恢复');
                }
            }
            
            // 恢复游戏
            function resumeGame() {
                console.log('恢复游戏');
                gamePaused = false;
                document.getElementById('gamePauseScreen').style.display = 'none';
            }
            
            // 重新开始游戏
            function restartGame() {
                console.log('重新开始游戏');
                showCharacterSelect();
            }
            
            // 处理键盘按下事件
            function handleKeyDown(e) {
                console.log('按键按下:', e.code);
                
                if (e.code === 'Space' || e.code === 'KeyW' || e.code === 'ArrowUp') {
                    jump();
                }
                
                if (e.code === 'ArrowLeft' || e.code === 'KeyA') {
                    player.velocityX = -5;
                }
                
                if (e.code === 'ArrowRight' || e.code === 'KeyD') {
                    player.velocityX = 5;
                }
                
                if (e.code === 'KeyP') {
                    togglePause();
                }
                
                if (e.code === 'KeyR' && gameOver) {
                    restartGame();
                }
                
                if (e.code === 'KeyC') {
                    if (gameStarted && !gamePaused && !gameOver) {
                        togglePause();
                        showCharacterSelect();
                    }
                }
            }
            
            // 处理键盘释放事件
            function handleKeyUp(e) {
                console.log('按键释放:', e.code);
                
                if (e.code === 'ArrowLeft' || e.code === 'KeyA' || 
                    e.code === 'ArrowRight' || e.code === 'KeyD') {
                    player.velocityX = 0;
                }
            }
            
            // 跳跃功能
            function jump() {
                console.log('尝试跳跃');
                
                if (player.onGround) {
                    player.velocityY = GAME_CONFIG.playerJumpStrength;
                    player.onGround = false;
                    player.jumping = true;
                    player.doubleJumpAvailable = true;
                    createParticles(player.x + player.width/2, player.y + player.height, 5, player.color);
                    console.log('跳跃成功');
                } else if (player.doubleJumpAvailable) {
                    player.velocityY = GAME_CONFIG.playerDoubleJumpStrength;
                    player.doubleJumpAvailable = false;
                    createParticles(player.x + player.width/2, player.y + player.height/2, 8, '#FFDD00');
                    console.log('二段跳成功');
                }
            }
            
            // 创建粒子效果
            function createParticles(x, y, count, color) {
                for (let i = 0; i < count; i++) {
                    particles.push({
                        x: x,
                        y: y,
                        radius: Math.random() * 3 + 1,
                        color: color,
                        velocityX: (Math.random() - 0.5) * 5,
                        velocityY: (Math.random() - 0.5) * 5,
                        life: 30 + Math.random() * 20
                    });
                }
            }
            
            // 显示提示消息
            function showToast(message) {
                const toast = document.createElement('div');
                toast.className = 'fixed top-4 right-4 bg-primary text-white px-4 py-2 rounded-lg shadow-lg z-50 transition-all duration-300 transform translate-x-full';
                toast.textContent = message;
                document.body.appendChild(toast);
                
                // 显示动画
                setTimeout(() => {
                    toast.classList.remove('translate-x-full');
                }, 10);
                
                // 3秒后隐藏
                setTimeout(() => {
                    toast.classList.add('translate-x-full');
                    setTimeout(() => {
                        document.body.removeChild(toast);
                    }, 300);
                }, 3000);
            }
            
            // 更新游戏状态
            function updateGameStats() {
                document.getElementById('currentScore').textContent = score;
                document.getElementById('lives').textContent = lives;
                document.getElementById('level').textContent = level;
                document.getElementById('coins').textContent = coins;
                document.getElementById('finalScore').textContent = score;
                document.getElementById('finalCoins').textContent = coins;
                document.getElementById('finalHighScore').textContent = highScore;
            }
            
            // 检测碰撞
            function checkCollision(rect1, rect2) {
                return rect1.x < rect2.x + rect2.width &&
                       rect1.x + rect1.width > rect2.x &&
                       rect1.y < rect2.y + rect2.height &&
                       rect1.y + rect1.height > rect2.y;
            }
            
            // 生成新平台
            function generatePlatforms() {
                // 获取最后一个平台
                const lastPlatform = platforms[platforms.length - 1];
                
                // 确保游戏中始终有足够的平台
                while (platforms.length < 10) {
                    // 计算新平台的位置
                    const platformWidth = Math.floor(Math.random() * (GAME_CONFIG.platformMaxWidth - GAME_CONFIG.platformMinWidth + 1)) + GAME_CONFIG.platformMinWidth;
                    const platformGap = Math.floor(Math.random() * (GAME_CONFIG.platformMaxGap - GAME_CONFIG.platformMinGap + 1)) + GAME_CONFIG.platformMinGap;
                    const platformX = lastPlatform.x + lastPlatform.width + platformGap;
                    const platformY = Math.floor(Math.random() * (GAME_CONFIG.platformMaxY - GAME_CONFIG.platformMinY + 1)) + GAME_CONFIG.platformMinY;
                    
                    // 随机选择平台类型
                    const platformTypes = ['london', 'scotland', 'wales', 'moving', 'spring'];
                    const randomType = platformTypes[Math.floor(Math.random() * platformTypes.length)];
                    
                    // 创建新平台
                    const newPlatform = {
                        x: platformX,
                        y: platformY,
                        width: platformWidth,
                        height: 20,
                        type: randomType
                    };
                    
                    // 如果是移动平台，添加移动属性
                    if (randomType === 'moving') {
                        newPlatform.direction = Math.random() > 0.5 ? 'horizontal' : 'vertical';
                        newPlatform.speed = 2;
                        newPlatform.range = 100;
                        newPlatform.startX = platformX;
                        newPlatform.startY = platformY;
                    }
                    
                    platforms.push(newPlatform);
                    
                    // 有一定概率在平台上生成障碍物
                    if (Math.random() < GAME_CONFIG.obstacleSpawnRate) {
                        const obstacleX = platformX + Math.random() * (platformWidth - 50);
                        const obstacleY = platformY - 20;
                        obstacles.push({
                            x: obstacleX,
                            y: obstacleY,
                            width: 50,
                            height: 20
                        });
                    }
                    
                    // 有一定概率在平台上生成金币
                    if (Math.random() < 0.7) {
                        const coinX = platformX + 10 + Math.random() * (platformWidth - 30);
                        const coinY = platformY - 30;
                        coinsList.push({
                            x: coinX,
                            y: coinY,
                            width: 10,
                            height: 10,
                            collected: false
                        });
                    }
                }
                
                // 移除屏幕外的平台
                platforms = platforms.filter(platform => platform.x + platform.width > 0);
                obstacles = obstacles.filter(obstacle => obstacle.x + obstacle.width > 0);
                coinsList = coinsList.filter(coin => coin.x + coin.width > 0 || !coin.collected);
            }
            
            // 检查玩家与平台的碰撞
            function checkPlatformCollision() {
                player.onGround = false;
                
                platforms.forEach(platform => {
                    // 移动平台逻辑
                    if (platform.type === 'moving') {
                        if (platform.direction === 'horizontal') {
                            platform.x = platform.startX + Math.sin(Date.now() / 1000) * platform.range;
                        } else {
                            platform.y = platform.startY + Math.sin(Date.now() / 1000) * platform.range;
                        }
                    }
                    
                    // 检查玩家是否从上方落在平台上
                    if (player.y + player.height <= platform.y && 
                        player.y + player.height + player.velocityY >= platform.y &&
                        player.x + player.width > platform.x && 
                        player.x < platform.x + platform.width) {
                        
                        player.y = platform.y - player.height;
                        player.velocityY = 0;
                        player.onGround = true;
                        player.jumping = false;
                        
                        // 如果是弹簧平台，给予额外弹跳力
                        if (platform.type === 'spring') {
                            player.velocityY = GAME_CONFIG.playerJumpStrength * 1.5;
                            player.onGround = false;
                            player.jumping = true;
                            createParticles(player.x + player.width/2, player.y + player.height, 10, '#FFDD00');
                        }
                    }
                });
            }
            
            // 检查玩家与障碍物的碰撞
            function checkObstacleCollision() {
                obstacles.forEach(obstacle => {
                    if (checkCollision(player, obstacle)) {
                        console.log('碰到障碍物！');
                        playerDied();
                    }
                });
            }
            
            // 检查玩家与金币的碰撞
            function checkCoinCollision() {
                coinsList.forEach(coin => {
                    if (!coin.collected && checkCollision(player, coin)) {
                        coin.collected = true;
                        coins++;
                        score += 100;
                        createParticles(coin.x + coin.width/2, coin.y + coin.height/2, 15, '#FFDD00');
                        showToast('+100 points!');
                        
                        // 检查是否达到升级条件
                        if (score % GAME_CONFIG.levelScoreThreshold === 0) {
                            levelUp();
                        }
                        
                        updateGameStats();
                    }
                });
            }
            
            // 玩家死亡
            function playerDied() {
                lives--;
                updateGameStats();
                
                if (lives <= 0) {
                    gameOver = true;
                    document.getElementById('gameOverScreen').style.display = 'flex';
                    
                    // 更新高分
                    if (score > highScore) {
                        highScore = score;
                        localStorage.setItem('highScore', highScore);
                        document.getElementById('finalHighScore').textContent = highScore;
                        showToast('New High Score!');
                    }
                } else {
                    // 重置玩家位置
                    player.x = 50;
                    player.y = 0;
                    player.velocityY = 0;
                    player.velocityX = 0;
                    player.doubleJumpAvailable = true;
                    
                    // 显示提示
                    showToast('Lost a life!');
                }
            }
            
            // 升级
            function levelUp() {
                level++;
                GAME_CONFIG.gravity *= 0.95; // 略微减少重力，增加难度
                GAME_CONFIG.obstacleSpawnRate += 0.05; // 增加障碍物生成概率
                
                // 显示升级提示
                document.getElementById('newLevel').textContent = level;
                document.getElementById('levelUpScreen').style.display = 'flex';
                gamePaused = true;
                
                updateGameStats();
            }
            
            // 获取平台颜色
            function getPlatformColor(type) {
                switch(type) {
                    case 'london':
                        return '#005EA5'; // 蓝色
                    case 'scotland':
                        return '#00823B'; // 绿色
                    case 'wales':
                        return '#D4351C'; // 红色
                    case 'moving':
                        return '#6366F1'; // 靛蓝色
                    case 'spring':
                        return '#F59E0B'; // 琥珀色
                    default:
                        return '#475569'; // 石板色
                }
            }
            
            // 绘制平台
            function drawPlatforms() {
                platforms.forEach(platform => {
                    ctx.fillStyle = getPlatformColor(platform.type);
                    ctx.fillRect(platform.x, platform.y, platform.width, platform.height);
                    
                    // 为不同类型的平台添加细节
                    if (platform.type === 'london') {
                        // 伦敦主题平台 - 添加红色双层巴士标志
                        ctx.fillStyle = '#D4351C';
                        ctx.fillRect(platform.x + platform.width/2 - 20, platform.y + 5, 40, 10);
                    } else if (platform.type === 'scotland') {
                        // 苏格兰主题平台 - 添加格子图案
                        ctx.fillStyle = '#FFFFFF';
                        for (let i = 0; i < platform.width; i += 15) {
                            ctx.fillRect(platform.x + i, platform.y, 5, platform.height);
                        }
                        for (let i = 0; i < platform.height; i += 10) {
                            ctx.fillRect(platform.x, platform.y + i, platform.width, 5);
                        }
                    } else if (platform.type === 'wales') {
                        // 威尔士主题平台 - 添加红色龙标志
                        ctx.fillStyle = '#FFFFFF';
                        ctx.fillRect(platform.x + platform.width/2 - 20, platform.y + 5, 40, 3);
                        ctx.fillRect(platform.x + platform.width/2 - 3, platform.y + 5, 3, 10);
                    } else if (platform.type === 'spring') {
                        // 弹簧平台 - 添加弹簧细节
                        ctx.fillStyle = '#F97316';
                        ctx.fillRect(platform.x + platform.width/2 - 15, platform.y - 5, 30, 5);
                    }
                });
            }
            
            // 绘制障碍物
            function drawObstacles() {
                obstacles.forEach(obstacle => {
                    ctx.fillStyle = '#D4351C'; // 红色障碍物
                    ctx.fillRect(obstacle.x, obstacle.y, obstacle.width, obstacle.height);
                    
                    // 添加障碍物细节
                    ctx.fillStyle = '#FFFFFF';
                    ctx.fillRect(obstacle.x + 5, obstacle.y + 5, obstacle.width - 10, 3);
                    ctx.fillRect(obstacle.x + 5, obstacle.y + 12, obstacle.width - 10, 3);
                });
            }
            
            // 绘制金币
            function drawCoins() {
                coinsList.forEach(coin => {
                    if (!coin.collected) {
                        // 金币闪烁效果
                        const flashRate = Math.sin(Date.now() / 200) * 0.3 + 0.7;
                        ctx.fillStyle = `rgba(255, 221, 0, ${flashRate})`;
                        
                        // 绘制金币
                        ctx.beginPath();
                        ctx.arc(coin.x + coin.width/2, coin.y + coin.height/2, coin.width/2, 0, Math.PI * 2);
                        ctx.fill();
                        
                        // 金币细节
                        ctx.strokeStyle = '#D4AF37';
                        ctx.lineWidth = 1;
                        ctx.stroke();
                        
                        ctx.fillStyle = '#D4AF37';
                        ctx.fillRect(coin.x + coin.width/2 - 2, coin.y + coin.height/2 - 2, 4, 4);
                    }
                });
            }
            
            // 绘制玩家
            function drawPlayer() {
                // 绘制玩家身体
                ctx.fillStyle = player.color;
                ctx.fillRect(player.x, player.y, player.width, player.height);
                
                // 绘制玩家头部
                ctx.fillStyle = '#FFFFFF';
                ctx.fillRect(player.x + 5, player.y + 5, 20, 10);
                
                // 绘制玩家眼睛
                ctx.fillStyle = '#000000';
                ctx.fillRect(player.x + 10, player.y + 8, 3, 3);
                ctx.fillRect(player.x + 17, player.y + 8, 3, 3);
                
                // 绘制玩家腿部
                if (player.onGround) {
                    ctx.fillStyle = player.color;
                    ctx.fillRect(player.x + 5, player.y + player.height, 5, 5);
                    ctx.fillRect(player.x + player.width - 10, player.y + player.height, 5, 5);
                }
                
                // 绘制玩家手臂
                if (player.velocityX > 0) {
                    // 向右移动
                    ctx.fillStyle = player.color;
                    ctx.fillRect(player.x + player.width, player.y + 15, 10, 5);
                } else if (player.velocityX < 0) {
                    // 向左移动
                    ctx.fillStyle = player.color;
                    ctx.fillRect(player.x - 10, player.y + 15, 10, 5);
                }
            }
            
            // 绘制粒子效果
            function drawParticles() {
                for (let i = 0; i < particles.length; i++) {
                    const p = particles[i];
                    
                    // 更新粒子位置
                    p.x += p.velocityX;
                    p.y += p.velocityY;
                    p.life--;
                    
                    // 绘制粒子
                    ctx.fillStyle = p.color;
                    ctx.beginPath();
                    ctx.arc(p.x, p.y, p.radius, 0, Math.PI * 2);
                    ctx.fill();
                    
                    // 移除寿命耗尽的粒子
                    if (p.life <= 0) {
                        particles.splice(i, 1);
                        i--;
                    }
                }
            }
            
            // 绘制游戏背景
            function drawBackground() {
                // 绘制天空渐变
                const gradient = ctx.createLinearGradient(0, 0, 0, canvas.height);
                gradient.addColorStop(0, '#0F172A');
                gradient.addColorStop(1, '#1E293B');
                ctx.fillStyle = gradient;
                ctx.fillRect(0, 0, canvas.width, canvas.height);
                
                // 绘制远处的英国地标剪影
                ctx.fillStyle = '#334155';
                
                // 大本钟
                ctx.fillRect(100, 150, 30, 200);
                ctx.fillRect(85, 120, 60, 30);
                ctx.fillRect(100, 120, 30, 30);
                
                // 伦敦眼
                ctx.beginPath();
                ctx.arc(300, 200, 60, 0, Math.PI * 2);
                ctx.strokeStyle = '#334155';
                ctx.lineWidth = 10;
                ctx.stroke();
                ctx.fillRect(295, 260, 10, 100);
                
                // 碎片大厦
                ctx.fillRect(450, 100, 40, 300);
                ctx.fillRect(470, 150, 10, 250);
                ctx.fillRect(430, 150, 10, 250);
                
                // 爱丁堡城堡
                ctx.fillRect(600, 150, 70, 200);
                ctx.fillRect(610, 100, 20, 50);
                ctx.fillRect(640, 100, 20, 50);
            }
            
            // 更新游戏状态
            function update() {
                // 应用重力
                player.velocityY += GAME_CONFIG.gravity;
                
                // 更新玩家位置
                player.x += player.velocityX;
                player.y += player.velocityY;
                
                // 边界检查
                if (player.x < 0) {
                    player.x = 0;
                } else if (player.x + player.width > canvas.width) {
                    player.x = canvas.width - player.width;
                }
                
                // 如果玩家掉出屏幕底部，死亡
                if (player.y > canvas.height) {
                    playerDied();
                }
                
                // 生成新平台
                generatePlatforms();
                
                // 检查平台碰撞
                checkPlatformCollision();
                
                // 检查障碍物碰撞
                checkObstacleCollision();
                
                // 检查金币碰撞
                checkCoinCollision();
                
                // 滚动屏幕
                if (player.y < canvas.height / 3) {
                    const scrollAmount = canvas.height / 3 - player.y;
                    player.y += scrollAmount;
                    
                    // 滚动所有平台、障碍物和金币
                    platforms.forEach(platform => {
                        platform.y += scrollAmount;
                    });
                    
                    obstacles.forEach(obstacle => {
                        obstacle.y += scrollAmount;
                    });
                    
                    coinsList.forEach(coin => {
                        coin.y += scrollAmount;
                    });
                    
                    // 增加分数
                    score += Math.floor(scrollAmount / 10);
                    
                    // 检查是否达到升级条件
                    if (score % GAME_CONFIG.levelScoreThreshold === 0) {
                        levelUp();
                    }
                    
                    updateGameStats();
                }
            }
            
            // 绘制游戏元素
            function draw() {
                // 绘制背景
                drawBackground();
                
                // 绘制平台
                drawPlatforms();
                
                // 绘制障碍物
                drawObstacles();
                
                // 绘制金币
                drawCoins();
                
                // 绘制玩家
                drawPlayer();
                
                // 绘制粒子效果
                drawParticles();
            }
            
            // 游戏循环
            function gameLoop() {
                if (!gamePaused && gameStarted && !gameOver) {
                    // 清除画布
                    ctx.clearRect(0, 0, canvas.width, canvas.height);
                    
                    // 更新和绘制游戏元素
                    update();
                    draw();
                    
                    // 更新分数（每秒增加）
                    score += 1;
                    if (score % 100 === 0) {
                        updateGameStats();
                    }
                }
                
                // 继续游戏循环
                requestAnimationFrame(gameLoop);
            }
            
            // 启动游戏
            initGame();
        });
    </script>
</body>
</html>    